<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>jurek36AI Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <style>
    /* Custom scrollbar for better appearance */
    /* Niestandardowy pasek przewijania dla lepszego wyglƒÖdu */
    #chat::-webkit-scrollbar {
      width: 8px;
    }
    #chat::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1); /* Slightly transparent track */
      border-radius: 10px;
    }
    #chat::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3); /* Slightly transparent thumb */
      border-radius: 10px;
    }
    #chat::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5); /* More visible on hover */
    }

    /* Animated Gradient Background */
    /* Animowane t≈Ço gradientowe */
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif; /* Ensure a fallback font */
      background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
      background-size: 400% 400%;
      animation: gradientAnimation 15s ease infinite; /* Slow, continuous animation */
      color: #333; /* Default text color */
    }

    @keyframes gradientAnimation {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Center and constrain the chat container */
    /* Wy≈õrodkowanie i ograniczenie kontenera czatu */
    .chat-container-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh; /* Full viewport height */
        padding: 1rem; /* p-4 */
        width: 100%; /* Ensure it takes full width for centering */
    }

    .chat-container {
        width: 100%;
        max-width: 500px; /* max-w-lg */
        background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white background */
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* shadow-xl */
        border-radius: 1rem; /* rounded-2xl */
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Hides container scrollbar */
        height: 90vh; /* h-[90vh] */
        max-height: 700px; /* max-h-[700px] */
    }

    /* Header styling */
    /* Styl nag≈Ç√≥wka */
    .chat-header {
      background: rgba(59, 130, 246, 0.8); /* Tailwind blue-500 with transparency */
      color: white;
      padding: 1.5rem; /* p-6 */
      font-size: 1.5rem; /* text-2xl */
      font-weight: bold;
      text-align: center;
      border-top-left-radius: 1rem; /* Match container border */
      border-top-right-radius: 1.rem; /* Match container border */
      position: relative; /* Needed for button positioning */
    }

    /* Main chat area styling */
    /* Styl g≈Ç√≥wnego obszaru czatu */
    .chat-main {
        flex: 1;
        padding: 1rem; /* p-4 */
        overflow-y: auto; /* THIS ENABLES VERTICAL SCROLLING */
        space-y: 1rem; /* space-y-4 */
        background-color: rgba(249, 250, 251, 0.7); /* Tailwind gray-50 with transparency */
    }

    /* Footer styling */
    /* Styl stopki */
    .chat-footer {
        padding: 1rem; /* p-4 */
        background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
        border-top: 1px solid #e5e7eb; /* border-t border-gray-200 */
        display: flex;
        flex-direction: column; /* Stack elements vertically */
        gap: 0.5rem; /* Space between input row and file info */
    }

    .input-row {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* Space between elements */
    }

    /* File input and info styling */
    /* Styl pola wyboru pliku i informacji o pliku */
    .file-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.875rem; /* text-sm */
        color: #4b5563; /* gray-700 */
        padding: 0.25rem 0;
    }

    .file-info-name {
        flex-grow: 1;
        margin-right: 0.5rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .file-clear-button {
        background: none;
        border: none;
        color: #ef4444; /* red-500 */
        cursor: pointer;
        font-size: 1rem;
        padding: 0;
        margin-left: 0.5rem;
    }

    /* Hide the default file input */
    .hidden-file-input {
        display: none;
    }

    /* Custom file input button styling (Paperclip) */
    /* Styl niestandardowego przycisku wyboru pliku (Spinacz) */
    .custom-file-upload {
        background-color: #60a5fa; /* blue-400 */
        color: white;
        padding: 0.5rem 0.75rem; /* py-2 px-3 */
        border-radius: 0.5rem 0 0 0.5rem; /* Rounded left, square right */
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
        font-size: 1.2rem; /* Larger size for the icon */
        display: flex; /* Use flex to center the icon */
        align-items: center;
        justify-content: center;
        line-height: 1; /* Adjust line height for centering */
    }

    .custom-file-upload:hover {
        background-color: #3b82f6; /* blue-500 */
    }


    /* Input styling */
    /* Styl pola wprowadzania */
    .chat-input {
        flex: 1;
        padding: 0.5rem 1rem; /* px-4 py-2 */
        border: 1px solid #d1d5db; /* border border-gray-300 */
        border-radius: 0; /* Square corners on both sides */
        outline: none;
        transition: border-color 0.2s ease-in-out, ring-color 0.2s ease-in-out;
    }

    .chat-input:focus {
        border-color: #60a5fa; /* focus:border-blue-500 */
        ring: 2px; /* focus:ring-2 */
        ring-color: #93c5fd; /* focus:ring-blue-300 */
    }
    .chat-input:disabled {
        background-color: #f3f4f6; /* disabled:bg-gray-100 */
        cursor: not-allowed;
    }

    /* Send button styling */
    /* Styl przycisku wy≈õlij */
    .chat-send-button {
        padding: 0.5rem 1rem; /* px-4 py-2 */
        background-color: #3b82f6; /* bg-blue-500 */
        color: white;
        border-radius: 0 0.5rem 0.5rem 0; /* Square left, rounded right */
        transition: background-color 0.2s ease-in-out;
        border: none; /* Remove default button border */
        cursor: pointer;
    }
    .chat-send-button:hover {
        background-color: #2563eb; /* hover:bg-blue-600 */
    }
    .chat-send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Message bubble styling */
    /* Styl dymk√≥w wiadomo≈õci */
    .message-bubble {
      display: inline-block;
      padding: 0.5rem 1rem; /* px-4 py-2 */
      border-radius: 0.5rem; /* General rounded corners */
      max-width: 80%;
      word-wrap: break-word; /* Prevent long words from overflowing */
      white-space: pre-wrap; /* Respect newlines in plain text messages */
    }

    .message-bubble.user {
      background-color: rgba(59, 130, 246, 0.9); /* blue-500 with transparency */
      color: white;
      border-top-right-radius: 0; /* Pointed corner */
    }

    .message-bubble.bot {
      background-color: rgba(229, 231, 235, 0.9); /* gray-200 with transparency */
      color: #1f2937; /* gray-800 */
      border-top-left-radius: 0; /* Pointed corner */
    }

    /* Style for blocks of code generated by marked.js */
    /* Styl dla blok√≥w kodu generowanych przez marked.js */
    .message-bubble pre {
      background-color: rgba(203, 213, 225, 0.8); /* Tailwind gray-300 with transparency */
      padding: 0.75rem; /* p-3 */
      border-radius: 0.5rem; /* rounded-lg */
      overflow-x: auto; /* Enables horizontal scrolling for long lines */
      position: relative; /* Needed for absolute positioning of the copy button */
      margin-top: 0.5rem; /* Some space above the code block */
      margin-bottom: 0.5rem; /* Some space below the code block */
      line-height: 1.4; /* Improve readability of code */
      color: #1f2937; /* Darker text for readability */
    }

    .message-bubble pre code {
      font-family: 'Fira Code', 'Cascadia Code', 'Source Code Pro', monospace; /* Prefer monospaced fonts */
      font-size: 0.9rem;
      display: block; /* Ensures code takes full width of pre block */
    }

    /* Basic Markdown styling for elements generated by marked.js */
    /* Podstawowy styl Markdown dla element√≥w generowanych przez marked.js */
    /* Adjust as needed to match your design system */
    .message-bubble strong {
      font-weight: bold;
    }
    .message-bubble em {
      font-style: italic;
    }
    .message-bubble a {
      color: #3182ce; /* Blue link */
      text-decoration: underline;
    }
    .message-bubble ul, .message-bubble ol {
      list-style-position: inside;
      padding-left: 1.25rem; /* pl-5 */
      margin-bottom: 0.5rem;
    }
    .message-bubble li {
      margin-bottom: 0.25rem;
    }
    .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4, .message-bubble h5, .message-bubble h6 {
      font-weight: bold;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      line-height: 1.2;
      color: #1f2937; /* Dark color for headings */
    }
    .message-bubble h1 { font-size: 1.5rem; } /* text-2xl */
    .message-bubble h2 { font-size: 1.25rem; } /* text-xl */
    .message-bubble h3 { font-size: 1.125rem; } /* text-lg */
    .message-bubble p {
      margin-bottom: 0.5rem;
    }

    /* Styling for attached image preview in user message */
    /* Stylizacja podglƒÖdu za≈ÇƒÖczonego obrazu w wiadomo≈õci u≈ºytkownika */
    .message-bubble.user img {
        max-width: 100%;
        height: auto;
        border-radius: 0.5rem;
        margin-top: 0.5rem; /* Space above the image if there's text */
    }


  </style>
</head>
<body>
  <div class="chat-container-wrapper">
    <div class="chat-container">
      <header class="chat-header">
        <h1>jurek36AI Chatbot</h1>
      </header>
      <main id="chat" class="chat-main">
        </main>
      <footer class="chat-footer">
        <div class="input-row">
            <label for="fileInput" class="custom-file-upload" title="Za≈ÇƒÖcz plik (obraz)">
                üìé
            </label>
            <input type="file" id="fileInput" class="hidden-file-input" accept="image/*" />


            <input id="message" type="text" placeholder="Napisz wiadomo≈õƒá..."
                   class="chat-input" />

            <button id="send" class="chat-send-button">
              Wy≈õlij
            </button>
        </div>
        <div id="fileInfo" class="file-info hidden">
            <span id="fileName" class="file-info-name"></span>
            <button id="clearFileBtn" class="file-clear-button">&times;</button>
        </div>
      </footer>
    </div>
  </div>

  <script>
    // !!! === BARDZO WA≈ªNE OSTRZE≈ªENIE BEZPIECZE≈ÉSTWA === !!!
    // PONI≈ªEJ MUSISZ WPROWADZIƒÜ SW√ìJ KLUCZ API GOOGLE GEMINI.
    // UMIESZCZANIE KLUCZA API BEZPO≈öREDNIO W KODZIE KLIENTA (FRONTENDU)
    // JEST BARDZO NIEBEZPIECZNE! KAZDY, KTO OTWORZY KONSOLƒò PRZEGLƒÑDARKƒò,
    // BƒòDZIE M√ìG≈Å ZOBACZYƒÜ I UKRA≈öƒÜ TW√ìJ KLUCZ.
    // ZALECAM U≈ªYCIE TEGO ROZWIƒÑZANIA TYLKO DO TEST√ìW/ROZWOJU LOKALNEGO.
    // DLA APLIKACJI PRODUKCYJNYCH ZAWSZE U≈ªYWAJ BEZPIECZNEGO BACKENDU,
    // KT√ìRY BƒòDZIE PRZECHOWYWA≈Å KLUCZ API I PO≈öREDNICZY≈Å W KOMUNIKACJI.
    const GEMINI_API_KEY = 'AIzaSyChSd5TnsmPwLYZAQclq_al2WC4KVULWNg'; // <--- TUTAJ WPROWAD≈π SW√ìJ KLUCZ API GOOGLE GEMINI

    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const fileInput = document.getElementById('fileInput'); // Reference to the file input
    // Referencja do pola wyboru pliku
    const fileInfo = document.getElementById('fileInfo'); // Area to display file info
    // Obszar do wy≈õwietlania informacji o pliku
    const fileNameSpan = document.getElementById('fileName'); // Span for file name
    // Span dla nazwy pliku
    const clearFileBtn = document.getElementById('clearFileBtn'); // Button to clear file
    // Przycisk do usuniƒôcia wybranego pliku
    const attachButtonLabel = document.querySelector('.custom-file-upload'); // Reference to the custom file upload label
    // Referencja do niestandardowej etykiety przycisku wyboru pliku


    let loadingMessageElement = null; // Reference to the loading indicator element
    // Referencja do elementu wska≈∫nika ≈Çadowania
    let currentLanguage = 'pl'; // Default language
    // Domy≈õlny jƒôzyk
    let attachedFile = null; // Variable to store the attached file data (base64) and mime type
    // Zmienna do przechowywania danych za≈ÇƒÖczonego pliku (base64) i typu mime

    // Marked.js configuration (optional but recommended for security and specific needs)
    // Konfiguracja Marked.js (opcjonalne, ale polecane dla bezpiecze≈Ñstwa i specyficznych potrzeb)
    marked.setOptions({
      breaks: true, // Render newlines as <br/>
      gfm: true,    // Enable GitHub Flavored Markdown
      // To add code syntax highlighting (coloring), uncomment the section below
      // and add the highlight.js CSS and JS links in the <head> section (see commented links).
      // Aby dodaƒá pod≈õwietlanie sk≈Çadni kodu (kolorowanie), odkomentuj poni≈ºszƒÖ sekcjƒô
      // i dodaj linki do highlight.js CSS i JS w sekcji <head> (patrz zakomentowane linki).
      // highlight: function(code, lang) {
      //   const hljs = require('highlight.js'); // In a browser environment, highlight.js is global
      //   // W ≈õrodowisku przeglƒÖdarki highlight.js jest globalne
      //   const language = hljs.getLanguage(lang) ? lang : 'plaintext';
      //   try {
      //     return hljs.highlight(code, { language }).value;
      //   } catch (e) {
      //     console.error("Highlighting error:", e);
      //     return code; // Return original code if highlighting fails
      //   }
      // },
    });

    // Dictionary of translations for various UI elements and messages
    // S≈Çownik t≈Çumacze≈Ñ dla r√≥≈ºnych element√≥w UI i komunikat√≥w
    const translations = {
      'pl': {
        systemMessage: 'Jeste≈õ pomocnym asystentem, kt√≥ry m√≥wi po polsku. Mo≈ºesz przetwarzaƒá tekst i obrazy. Gdy odpowiadasz, mo≈ºesz u≈ºywaƒá formatowania Markdown takiego jak **pogrubienie**, *kursywa*, `kod inline` lub bloki kodu:\n```javascript\nconsole.log("Witaj!");\n```\n. Tw√≥j jƒôzyk jest polski.',
        inputPlaceholder: 'Napisz wiadomo≈õƒá...',
        sendButtonText: 'Wy≈õlij',
        loadingText: 'jurek36AI pisze...',
        errorGeneric: 'WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd komunikacji.',
        errorApi: 'B≈ÇƒÖd API Gemini.',
        errorApiRequest: 'B≈ÇƒÖd ≈ºƒÖdania (400). Upewnij siƒô, ≈ºe Tw√≥j klucz API i tre≈õƒá ≈ºƒÖdania sƒÖ poprawne.',
        errorApiAuth: 'B≈ÇƒÖd autoryzacji (401). Sprawd≈∫ sw√≥j klucz API Gemini.',
        errorApiQuota: 'Przekroczono limit zapyta≈Ñ (429). Spr√≥buj ponownie p√≥≈∫niej.',
        errorApiServer: (status) => `B≈ÇƒÖd serwera Gemini (HTTP ${status}). Spr√≥buj ponownie p√≥≈∫niej.`,
        errorNoReply: 'Nie otrzymano odpowiedzi tekstowej od bota Gemini.',
        copyButtonText: 'Kopiuj', // Kept for potential future use, but not used
        // Zachowane na wypadek przysz≈Çego u≈ºycia, ale nieu≈ºywane
        copiedButtonText: 'Skopiowano!', // Kept for potential future use, but not used
        // Zachowane na wypadek przysz≈Çego u≈ºycia, ale nieu≈ºywane
        attachButtonText: 'üìé', // Paperclip icon for the attach button
        // Ikona spinacza dla przycisku za≈ÇƒÖczania
        attachButtonTitle: 'Za≈ÇƒÖcz plik (obraz)', // Tooltip text
        // Tekst podpowiedzi (tooltip)
        clearFileButtonText: '&times;' // Text for the clear file button
        // Tekst dla przycisku usuwania pliku
      },
      'en': {
        systemMessage: 'You are a helpful assistant who speaks English. You can process text and images. When responding, you can use Markdown formatting like **bold**, *italics*, `inline code` or code blocks:\n```javascript\nconsole.log("Hello!");\n```\n. Your language is English.',
        inputPlaceholder: 'Write a message...',
        sendButtonText: 'Send',
        loadingText: 'jurek36AI is typing...',
        errorGeneric: 'An unexpected communication error occurred.',
        errorApi: 'Gemini API Error.',
        errorApiRequest: 'Bad request (400). Ensure your API key and request body are correct.',
        errorApiAuth: 'Authorization error (401). Check your Gemini API key.',
        errorApiQuota: 'Quota exceeded (429). Try again later.',
        errorApiServer: (status) => `Gemini server error (HTTP ${status}). Please try again later.`,
        errorNoReply: 'No text reply received from Gemini bot.',
        copyButtonText: 'Copy', // Kept for potential future use, but not used
        copiedButtonText: 'Copied!', // Kept for potential future use, but not used
        attachButtonText: 'üìé', // Paperclip icon for the attach button
        attachButtonTitle: 'Attach file (image)', // Tooltip text
        clearFileButtonText: '&times;' // Text for the clear file button
      }
    };

    // Function to apply language to UI elements
    // Funkcja do stosowania jƒôzyka do element√≥w UI
    function applyLanguageToUI() {
      const langData = translations[currentLanguage] || translations['en']; // Fallback to English
      // Fallback na angielski
      messageInput.placeholder = langData.inputPlaceholder;
      sendBtn.innerText = langData.sendButtonText;
      attachButtonLabel.innerText = langData.attachButtonText; // Set icon
      attachButtonLabel.title = langData.attachButtonTitle; // Set tooltip
      clearFileBtn.innerHTML = langData.clearFileButtonText; // Use innerHTML for &times;
    }

    // Function to detect and set language based on user's IP (approximate)
    // Funkcja do wykrywania i ustawiania jƒôzyka na podstawie IP u≈ºytkownika (przybli≈ºone)
    async function detectAndSetLanguage() {
      try {
        const response = await fetch('http://ip-api.com/json/?fields=countryCode');
        const data = await response.json();

        if (data.status === 'success' && data.countryCode) {
          if (data.countryCode.toUpperCase() === 'PL') {
            currentLanguage = 'pl';
          } else {
            currentLanguage = 'en';
          }
        } else {
          console.warn('Could not detect language from IP. Status:', data.status, data.message);
        }
      } catch (error) {
        console.warn('Error detecting language from IP, defaulting to', currentLanguage, '. Error:', error);
      } finally {
        applyLanguageToUI();
      }
    }

    // Function to handle file selection
    // Funkcja do obs≈Çugi wyboru pliku
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // Check if the file is an image
            if (!file.type.startsWith('image/')) {
                alert('Proszƒô wybraƒá plik obrazu.'); // Alert for non-image files
                clearAttachedFile(); // Clear the input
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                // Store the base64 data and mime type
                attachedFile = {
                    data: e.target.result.split(',')[1], // Get base64 string after the comma
                    mime_type: file.type
                };
                // Display file name and show the info area
                fileNameSpan.innerText = file.name;
                fileInfo.classList.remove('hidden');
            };
            reader.onerror = (e) => {
                console.error("Error reading file:", e);
                alert("WystƒÖpi≈Ç b≈ÇƒÖd podczas odczytu pliku."); // Alert on read error
                clearAttachedFile();
            };
            reader.readAsDataURL(file); // Read file as Data URL (base64)
        } else {
            clearAttachedFile(); // Clear if no file is selected
        }
    }

    // Function to clear the attached file
    // Funkcja do usuniƒôcia za≈ÇƒÖczonego pliku
    function clearAttachedFile() {
        attachedFile = null;
        fileInput.value = ''; // Clear the file input
        fileNameSpan.innerText = '';
        fileInfo.classList.add('hidden'); // Hide the info area
    }


    // Function to append messages to the chat window
    // Funkcja do dodawania wiadomo≈õci do okna czatu
    function appendMessage(text, sender, imageData = null) {
      const langData = translations[currentLanguage] || translations['en'];

      const wrapper = document.createElement('div');
      wrapper.className = sender === 'user'
        ? 'text-right'
        : 'text-left';

      const bubble = document.createElement('div');
      // Add Tailwind classes and custom 'message-bubble' class
      // Dodajemy klasy Tailwind i niestandardowƒÖ klasƒô 'message-bubble'
      bubble.className = (sender === 'user'
        ? 'message-bubble user' // Use custom CSS classes
        // U≈ºywamy niestandardowych klas CSS
        : 'message-bubble bot');

      if (sender === 'bot') {
        // Parse Markdown to HTML using marked.js
        // Parsuj Markdown do HTML u≈ºywajƒÖc marked.js
        let htmlContent = marked.parse(text);

        // !!! Important for security: Sanitize HTML using DOMPurify !!!
        // !!! Wa≈ºne dla bezpiecze≈Ñstwa: Sanityzacja HTML za pomocƒÖ DOMPurify !!!
        htmlContent = DOMPurify.sanitize(htmlContent, {
          USE_PROFILES: { html: true }
        });

        // Bold the word "tak" (case-insensitive, whole word)
        // Pogrubienie s≈Çowa "tak" (bez rozr√≥≈ºniania wielko≈õci liter, ca≈Çe s≈Çowo)
        htmlContent = htmlContent.replace(/\b(tak)\b/gi, '<strong>$1</strong>');

        bubble.innerHTML = htmlContent;

      } else { // sender === 'user'
        let content = text;
        if (imageData) {
            // Display the image in the user's message bubble
            // Wy≈õwietl obraz w dymku wiadomo≈õci u≈ºytkownika
            content += `<br><img src="data:${imageData.mime_type};base64,${imageData.data}" alt="Attached image">`;
        }
        // Parse Markdown for user message text if needed, but for simplicity, using innerHTML directly
        // Mo≈ºna sparsowaƒá Markdown dla tekstu wiadomo≈õci u≈ºytkownika, je≈õli potrzebne, ale dla prostoty, u≈ºywamy innerHTML bezpo≈õrednio
         bubble.innerHTML = content; // Use innerHTML to render <br> and <img>
      }

      wrapper.appendChild(bubble); // Add bubble to wrapper element
      // Dodaj dymek do elementu opakowujƒÖcego
      chat.appendChild(wrapper); // Add wrapper element to chat container
      // Dodaj element opakowujƒÖcy do kontenera czatu

      // Scroll to the bottom when a new message is added
      // Przewi≈Ñ do do≈Çu, gdy dodana zostanie nowa wiadomo≈õƒá
      chat.scrollTop = chat.scrollHeight;
      return bubble;
    }

    // Function to add a temporary loading indicator
    // Funkcja do dodawania tymczasowego wska≈∫nika ≈Çadowania
    function appendLoadingIndicator() {
      const langData = translations[currentLanguage] || translations['en'];
      const wrapper = document.createElement('div');
      wrapper.className = 'text-left';

      const bubble = document.createElement('div');
      bubble.innerText = langData.loadingText;
      bubble.className = 'inline-block bg-gray-200 text-gray-600 px-4 py-2 rounded-tr-lg rounded-br-lg rounded-bl-lg animate-pulse max-w-[80%]';

      wrapper.appendChild(bubble);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      loadingMessageElement = wrapper;
    }

    // Function to remove the loading indicator
    // Funkcja do usuwania wska≈∫nika ≈Çadowania
    function removeLoadingIndicator() {
      if (loadingMessageElement && loadingMessageElement.parentNode) {
        loadingMessageElement.parentNode.removeChild(loadingMessageElement);
        loadingMessageElement = null;
      }
    }

    // Function to handle sending messages to the Gemini API
    // Funkcja do obs≈Çugi wysy≈Çania wiadomo≈õci do API Gemini
    async function sendMessage(message) {
      // Don't send if message is empty and no file is attached
      // Nie wysy≈Çaj, je≈õli wiadomo≈õƒá jest pusta i ≈ºaden plik nie jest za≈ÇƒÖczony
      if (!message.trim() && !attachedFile) return;

      // Append user message and image (if attached) to the chat
      // Dodaj wiadomo≈õƒá u≈ºytkownika i obraz (je≈õli za≈ÇƒÖczony) do czatu
      appendMessage(message, 'user', attachedFile);

      // Clear input and file after appending user message
      // Wyczy≈õƒá pole wprowadzania i plik po dodaniu wiadomo≈õci u≈ºytkownika
      messageInput.value = '';
      clearAttachedFile();


      sendBtn.disabled = true;
      messageInput.disabled = true;
      fileInput.disabled = true; // Disable file input too
      clearFileBtn.disabled = true; // Disable clear button


      appendLoadingIndicator();

      const langData = translations[currentLanguage] || translations['en'];

      try {
        // Using gemini-1.5-flash as requested
        // U≈ºywamy gemini-1.5-flash zgodnie z ≈ºƒÖdaniem
        const modelToUse = 'gemini-1.5-flash';

        // Prepare the parts array for the API request
        // Przygotuj tablicƒô 'parts' dla ≈ºƒÖdania API
        const parts = [];

        // Add text part if message is not empty
        // Dodaj czƒô≈õƒá tekstowƒÖ, je≈õli wiadomo≈õƒá nie jest pusta
        if (message.trim()) {
            parts.push({
                text: message
            });
        }

        // Add image part if a file is attached
        // Dodaj czƒô≈õƒá obrazu, je≈õli plik jest za≈ÇƒÖczony
        if (attachedFile) {
            parts.push({
                inline_data: {
                    mime_type: attachedFile.mime_type,
                    data: attachedFile.data
                }
            });
        }


        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${GEMINI_API_KEY}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contents: [{
              parts: parts // Use the prepared parts array
              // U≈ºyj przygotowanej tablicy 'parts'
            }],
            system_instruction: {
                parts: [{
                    text: langData.systemMessage
                }]
            }
          })
        });

        if (!res.ok) {
          const errorData = await res.json();
          let displayErrorMessage = langData.errorApi;

          if (errorData.error && errorData.error.message) {
            displayErrorMessage += ` ${errorData.error.message}`;
          } else {
            if (res.status === 400) {
               displayErrorMessage += `: ${langData.errorApiRequest}`;
            } else if (res.status === 401) {
               displayErrorMessage += `: ${langData.errorApiAuth}`;
            } else if (res.status === 429) {
               displayErrorMessage += `: ${langData.errorApiQuota}`;
            } else if (res.status >= 500) {
               displayErrorMessage = langData.errorApiServer(res.status);
            } else {
               displayErrorMessage += ` (Kod statusu: ${res.status})`;
            }
          }
          throw new Error(displayErrorMessage);
        }

        const data = await res.json();
        const reply = data.candidates && data.candidates[0] &&
                      data.candidates[0].content && data.candidates[0].content.parts &&
                      data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text;

        if (!reply) {
             // Handle cases where the API might respond without text (e.g., just an image analysis)
            // Obs≈Çu≈º przypadki, gdy API mo≈ºe odpowiedzieƒá bez tekstu (np. tylko analiza obrazu)
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                 // Try to find any part that might be displayable, or just log the response
                // Spr√≥buj znale≈∫ƒá dowolnƒÖ czƒô≈õƒá, kt√≥rƒÖ mo≈ºna wy≈õwietliƒá, lub po prostu zaloguj odpowied≈∫
                console.warn("Gemini API returned content without a text part:", data);
                // Optionally display a generic "Processed" message or similar
                // Opcjonalnie wy≈õwietl og√≥lny komunikat "Przetworzono" lub podobny
                appendMessage("Bot processed the input.", 'bot'); // You can customize this message
                // Mo≈ºesz dostosowaƒá ten komunikat
            } else {
                 throw new Error(langData.errorNoReply);
            }
        } else {
             removeLoadingIndicator();
             appendMessage(reply, 'bot');
        }


      } catch (err) {
        removeLoadingIndicator();
        console.error('WystƒÖpi≈Ç b≈ÇƒÖd komunikacji z Gemini API:', err);
        appendMessage(`${langData.errorApi}: ${err.message || langData.errorGeneric}`, 'bot');
      } finally {
        sendBtn.disabled = false;
        messageInput.disabled = false;
        fileInput.disabled = false; // Re-enable file input
        clearFileBtn.disabled = false; // Re-enable clear button
        messageInput.focus();
      }
    }

    // Event listeners
    // Nas≈Çuchiwacze zdarze≈Ñ
    sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
    messageInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        sendMessage(messageInput.value);
      }
    });

    // Event listener for file input change
    // Nas≈Çuchiwacz zdarze≈Ñ dla zmiany w polu wyboru pliku
    fileInput.addEventListener('change', handleFileSelect);

    // Event listener for clear file button
    // Nas≈Çuchiwacz zdarze≈Ñ dla przycisku usuwania pliku
    clearFileBtn.addEventListener('click', clearAttachedFile);


    // Set focus on the input field after page load
    // Ustaw fokus na polu wprowadzania po za≈Çadowaniu strony
    messageInput.focus();

    // Detect and set language after page load
    // Wykryj i ustaw jƒôzyk po za≈Çadowaniu strony
    window.onload = detectAndSetLanguage;
  </script>
</body>
</html>
